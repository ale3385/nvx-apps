<?xml version="1.0"?>
<model xmlns="http://www.neeveresearch.com/schema/x-ddl" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <systemDetails>
    <displayName>Ad Serving System</displayName>
    <name>nvx-app-ad-bidding-engine</name>
    <version>1.0-SNAPSHOT</version>
  </systemDetails>

  <env>
    <nv>
      <!-- Configure to optimize for latency -->
      <optimizefor>latency</optimizefor>
      <stats.latencymanager.samplesize>65536</stats.latencymanager.samplesize>
      <msg.latency.stats>true</msg.latency.stats>
      <ods.latency.stats>true</ods.latency.stats>
      <link.network.stampiots>true</link.network.stampiots>
    </nv>

    <nv>
      <aep.trace>config</aep.trace>
    </nv>

    <!-- Configure the test drivers -->
    <driver.sendRate>100</driver.sendRate>
    <driver.sendCount>1000</driver.sendCount>
  </env>

  <buses>
    <bus name="ad-bidding"
      descriptor="${AD_BIDDING_BUS_DESCRIPTOR::solace://192.168.1.9:55555&amp;use_default_queue_name=true&amp;SESSION_VPN_NAME=default&amp;SESSION_USERNAME=test&amp;usejni=true&amp;FLOW_FORWARDING_MODE=2&amp;consumer_cpu_affinity_mask=${ADBIDDING_BUS_CONSUMER_CPUAFFMASK::0}&amp;producer_cpu_affinity_mask=${ADBIDDING_BUS_PRODUCER_CPUAFFMASK::0}&amp;detached_sends=false&amp;detached_dispatch=false&amp;sender_cpu_affinity_mask=[8]&amp;publish_window_size=255&amp;detached_dispatch_queue_depth=128&amp;dispatcher_cpu_affinity_mask=[1]}">
      <channels>
        <channel name="client_ad_responses" id="10">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="client_ad_requests" id="20">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="ad_requests" id="30">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="ad_responses" id="40">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="bid_responses" id="50">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="bid_requests" id="60">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="visitor_lookup_responses" id="70">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="visitor_lookup_requests" id="80">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="manage_visitors_requests" id="90">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="win_bid_notify_requests" id="100">
          <qos>Guaranteed</qos>
        </channel>
        <channel name="manage_campaigns_requests" id="110">
          <qos>Guaranteed</qos>
        </channel>
      </channels>
    </bus>
  </buses>

  <apps>
    <app name="driver" displayName="TestDriver App" mainClass="com.neeve.ads.driver.AdRequestDriverApplication">
      <messaging>
        <factories>
          <factory name="com.neeve.ads.messages.MessageFactory" />
        </factories>
        <bus name="ad-bidding">
          <channels>
            <channel name="client_ad_responses" join="true" />
            <channel name="client_ad_requests" join="false" />
            <channel name="manage_visitors_requests" join="false" />
            <channel name="manage_campaigns_requests" join="false" />
          </channels>
          <detachedSend enabled="true">
            <queueDrainerCpuAffinityMask>${DRIVER_BUSMANAGER_SEND_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedSend>
        </bus>
      </messaging>
      <storage enabled="true">
        <clustering enabled="false" />
        <persistence enabled="false" />
      </storage>
      
      <captureTransactionLatencyStats>true</captureTransactionLatencyStats>
      <captureEventLatencyStats>true</captureEventLatencyStats>
      <captureMessageTypeStats>true</captureMessageTypeStats>
      
      <inboundEventAcknowledgementPolicy>OnStoreStability</inboundEventAcknowledgementPolicy>
      <inboundEventMultiplexing>
        <queueDrainerCpuAffinityMask>${DRIVER_INPUT_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
      </inboundEventMultiplexing>
      
      <sequenceUnsolicitedWithSolicitedSends>true</sequenceUnsolicitedWithSolicitedSends>
    </app>

    <app name="ssp" displayName="SSP App" mainClass="com.neeve.ads.SSPApplication">
      <messaging>
        <factories>
          <factory name="com.neeve.ads.messages.MessageFactory" />
        </factories>
        <bus name="ad-bidding">
          <channels>
            <channel name="client_ad_responses" join="false" />
            <channel name="client_ad_requests" join="true" />
            <channel name="ad_responses" join="true" />
            <channel name="ad_requests" join="false" />
          </channels>
          <detachedSend enabled="true">
            <queueDrainerCpuAffinityMask>${DRIVER_BUSMANAGER_SEND_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedSend>
        </bus>
      </messaging>
      
      <storage enabled="true">
        <clustering enabled="false" />
        <persistence enabled="false">
          <detachedPersist enabled="true">
            <queueDrainerCpuAffinityMask>${SSP_PERSISTER_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedPersist>
          <flushOnCommit>true</flushOnCommit>
          <flushUsingMappedMemory>true</flushUsingMappedMemory>
        </persistence>
        <persistenceQuorum>1</persistenceQuorum>
      </storage>
      
      <captureTransactionLatencyStats>true</captureTransactionLatencyStats>
      <captureEventLatencyStats>true</captureEventLatencyStats>
      <captureMessageTypeStats>true</captureMessageTypeStats>
      
      <inboundEventAcknowledgementPolicy>OnStoreStability</inboundEventAcknowledgementPolicy>
      <inboundEventMultiplexing>
        <queueDrainerCpuAffinityMask>${SSP_INPUT_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
      </inboundEventMultiplexing>
    </app>

    <app name="ad-exchange" displayName="AdExchange App" mainClass="com.neeve.ads.AdExchangeApplication">
      <messaging>
        <factories>
          <factory name="com.neeve.ads.messages.MessageFactory" />
        </factories>
        <bus name="ad-bidding">
          <channels>
            <channel name="ad_responses" join="false" />
            <channel name="ad_requests" join="true" />
            <channel name="visitor_lookup_responses" join="true" />
            <channel name="bid_responses" join="true" />
            <channel name="visitor_lookup_requests" join="false" />
            <channel name="bid_requests" join="false" />
            <channel name="win_bid_notify_requests" join="false" />
          </channels>
          <detachedSend enabled="true">
            <queueDrainerCpuAffinityMask>${AD_EXCHANGE_BUSMANAGER_SEND_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedSend>
        </bus>
      </messaging>
      
      <storage>
        <factories>
          <factory name="com.neeve.ads.messages.MessageFactory" />
          <factory name="com.neeve.ads.state.StateFactory" />
        </factories>
        
        <clustering enabled="true">
          <localPort>12000</localPort>
          <localIfAddr>${AD_EXCHANGE_STORE_ADDR::0.0.0.0}</localIfAddr>
          <linkParams>nativeio=true,eagerread=true,maxreadspintime=1000000</linkParams>
          <linkReaderCpuAffinityMask>${AD_EXCHANGE_STORE_READER_CPUAFFMASK::0}</linkReaderCpuAffinityMask>
          <detachedSend enabled="true">
            <queueDrainerCpuAffinityMask>${AD_EXCHANGE_STORE_SENDER_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedSend>
          <detachedDispatch enabled="false">
            <queueDrainerCpuAffinityMask>${AD_EXCHANGE_STORE_DISPATCH_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedDispatch>
        </clustering>
        
        <persistence enabled="false">
          <detachedPersist enabled="true">
            <queueDrainerCpuAffinityMask>${AD_EXCHANGE_PERSISTER_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedPersist>
          <flushOnCommit>true</flushOnCommit>
          <flushUsingMappedMemory>true</flushUsingMappedMemory>
        </persistence>
        <persistenceQuorum>1</persistenceQuorum>
      </storage>
      
      <captureTransactionLatencyStats>true</captureTransactionLatencyStats>
      <captureEventLatencyStats>true</captureEventLatencyStats>
      <captureMessageTypeStats>true</captureMessageTypeStats>
      <inboundEventAcknowledgementPolicy>OnStoreStability</inboundEventAcknowledgementPolicy>
      <inboundEventMultiplexing>
        <queueDrainerCpuAffinityMask>${AD_EXCHANGE_INPUT_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
      </inboundEventMultiplexing>
    </app>

    <app name="dmp" displayName="DMP App" mainClass="com.neeve.ads.DMPApplication">
      <messaging>
        <factories>
          <factory name="com.neeve.ads.messages.MessageFactory" />
        </factories>
        <bus name="ad-bidding">
          <channels>
            <channel name="visitor_lookup_requests" join="true" />
            <channel name="manage_visitors_requests" join="true" />
            <channel name="visitor_lookup_responses" join="false" />
          </channels>
          <detachedSend enabled="true">
            <queueDrainerCpuAffinityMask>${DMP_BUSMANAGER_SEND_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedSend>
        </bus>
      </messaging>
      <storage enabled="true">
        <clustering enabled="false" />
        <persistence enabled="false">
          <detachedPersist enabled="true">
            <queueDrainerCpuAffinityMask>${DMP_PERSISTER_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedPersist>
          <flushOnCommit>true</flushOnCommit>
          <flushUsingMappedMemory>true</flushUsingMappedMemory>
        </persistence>
        <persistenceQuorum>1</persistenceQuorum>
      </storage>
      <captureTransactionLatencyStats>true</captureTransactionLatencyStats>
      <captureEventLatencyStats>true</captureEventLatencyStats>
      <captureMessageTypeStats>true</captureMessageTypeStats>
      <inboundEventAcknowledgementPolicy>OnStoreStability</inboundEventAcknowledgementPolicy>
      <inboundEventMultiplexing>
        <queueDrainerCpuAffinityMask>${DMP_INPUT_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
      </inboundEventMultiplexing>
    </app>

    <app name="dsp" displayName="DSP App" mainClass="com.neeve.ads.DSPApplication">
      <messaging>
        <factories>
          <factory name="com.neeve.ads.messages.MessageFactory" />
        </factories>
        <bus name="ad-bidding">
          <channels>
            <channel name="bid_requests" join="true" />
            <channel name="win_bid_notify_requests" join="true" />
            <channel name="manage_campaigns_requests" join="true" />
            <channel name="bid_responses" join="false" />
          </channels>
          <detachedSend enabled="true">
            <queueDrainerCpuAffinityMask>${DSP_BUSMANAGER_SEND_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedSend>
        </bus>
      </messaging>
      <storage enabled="true">
        <clustering enabled="false" />
        <persistence enabled="false">
          <detachedPersist enabled="true">
            <queueDrainerCpuAffinityMask>${DSP_PERSISTER_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
          </detachedPersist>
          <flushOnCommit>true</flushOnCommit>
          <flushUsingMappedMemory>true</flushUsingMappedMemory>
        </persistence>
        <persistenceQuorum>1</persistenceQuorum>
      </storage>
      <captureTransactionLatencyStats>true</captureTransactionLatencyStats>
      <captureEventLatencyStats>true</captureEventLatencyStats>
      <captureMessageTypeStats>true</captureMessageTypeStats>
      <inboundEventAcknowledgementPolicy>OnStoreStability</inboundEventAcknowledgementPolicy>
      <inboundEventMultiplexing>
        <queueDrainerCpuAffinityMask>${DSP_INPUT_CPUAFFMASK::0}</queueDrainerCpuAffinityMask>
      </inboundEventMultiplexing>
    </app>
  </apps>

  <servers>
    <templates>
      <server name="server-template">
        <autoStopOnLastAppStop>false</autoStopOnLastAppStop>
        <heartbeats enabled="true" interval="5">
          <tracing enabled="false">
            <traceAdminClientStats>false</traceAdminClientStats>
            <traceAppStats>false</traceAppStats>
            <tracePoolStats>false</tracePoolStats>
            <traceSysStats>false</traceSysStats>
            <traceThreadStats>false</traceThreadStats>
            <traceUserStats>false</traceUserStats>
          </tracing>
        </heartbeats>
      </server>
    </templates>
  
    <server name="driver-1" displayName="TestDriver Server" template="server-template">
      <apps>
        <app name="driver" autoStart="true" />
      </apps>
    </server>
    
    <server name="ssp-1" displayName="SSP Server" template="server-template">
      <apps>
        <app name="ssp" autoStart="true" />
      </apps>
    </server>
    
    <server name="ad-exchange-1" displayName="AdExchange Primary Server" template="server-template">
      <apps>
        <app name="ad-exchange" autoStart="true" />
      </apps>
    </server>
    
    <server name="ad-exchange-2" displayName="AdExchange Backup Server" template="server-template">
      <apps>
        <app name="ad-exchange" autoStart="true" />
      </apps>
    </server>
    
    <server name="dmp-1" displayName="DMP Server" template="server-template">
      <apps>
        <app name="dmp" autoStart="true" />
      </apps>
    </server>
    
    <server name="dsp-1" displayName="DSP Server" template="server-template">
      <apps>
        <app name="dsp" autoStart="true" />
      </apps>
    </server>
  </servers>
  
</model>
